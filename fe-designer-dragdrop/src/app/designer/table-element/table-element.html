@let rowSizes = getRowSizes();
@let colSizes = getColSizes();

<div class="table-element-container">
  <table class="element-table" aria-label="Table element">
    <tbody>
      @for (rowSize of rowSizes; track $index; let rowIndex = $index) {
        <tr [style.height.mm]="element.height * rowSize">
          @for (colSize of colSizes; track $index; let colIndex = $index) {
            <td
              [style.width.mm]="element.width * colSize"
              [style.height.mm]="element.height * rowSize"
              (click)="onCellClick($event, rowIndex, colIndex)"
              [class.selected]="isCellSelected(rowIndex, colIndex)"
              [style.padding]="getCellPaddingString(rowIndex,colIndex)"
              [style.text-align]="getCellHAlign(rowIndex,colIndex)"
              [style.vertical-align]="getCellVAlign(rowIndex,colIndex)"
              [style.border]="getCellBorder(rowIndex,colIndex)"
              [style.font-style]="getCellFontStyle(rowIndex,colIndex)"
              [style.font-weight]="getCellFontWeight(rowIndex,colIndex)"
              [style.font-size]="getCellFontSize(rowIndex,colIndex)"
              [style.line-height]="getCellLineHeight(rowIndex,colIndex)"
              [style.font-family]="getCellFontFamily(rowIndex,colIndex)"
              [style.text-decoration]="getCellTextDecoration(rowIndex,colIndex)"
            >
              <div class="cell-content"
                   [style.display]="'flex'"
                   [style.flexDirection]="'column'"
                   [style.justifyContent]="getCellVAlignFlex(rowIndex,colIndex)"
                   [style.textAlign]="getCellHAlign(rowIndex,colIndex)"
                   [style.overflow]="'auto'"
                   [innerHTML]="getCellContent(rowIndex, colIndex)"></div>
            </td>
          }
        </tr>
      }
    </tbody>
  </table>

  @for (_ of rowSizes; track $index; let rowIndex = $index) {
    @if (rowIndex < rowSizes.length - 1) {
      <div
        class="table-resize-handle horizontal"
        [style.top.%]="getRowHandleOffset(rowSizes, rowIndex)"
        [class.resizing]="isResizing('row', rowIndex)"
        (mousedown)="startRowResize(rowIndex, $event)"
      ></div>
    }
  }

  @for (_ of colSizes; track $index; let colIndex = $index) {
    @if (colIndex < colSizes.length - 1) {
      <div
        class="table-resize-handle vertical"
        [style.left.%]="getColHandleOffset(colSizes, colIndex)"
        [class.resizing]="isResizing('col', colIndex)"
        (mousedown)="startColResize(colIndex, $event)"
      ></div>
    }
  }

  @let cellOffsets = getSelectedCellOffsets();
  @if (cellOffsets) {
    <!-- Actions trigger button (gear icon) -->
    <button
      class="cell-actions-trigger"
      [style.left.mm]="cellOffsets.left + cellOffsets.width - 5"
      [style.top.mm]="cellOffsets.top + 2"
      (click)="toggleActionsToolbar(); $event.stopPropagation()"
      title="Actions"
      type="button"
    >âš™</button>

    <!-- Actions toolbar (shown when toggled) -->
    @if (showActionsToolbar()) {
      <div
        class="cell-actions-toolbar"
        [style.left.mm]="cellOffsets.left + cellOffsets.width / 2"
        [style.top.mm]="cellOffsets.top"
        (click)="$event.stopPropagation()"
      >
        <button class="cell-action" type="button" (click)="onEditCellContent()" title="Edit Cell Content">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M11.5 1.5L14.5 4.5L5 14H2V11L11.5 1.5Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <button class="cell-action" type="button" (click)="onSplitRowsFromToolbar()" title="Split Rows">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="2" y="2" width="12" height="4" stroke="currentColor" stroke-width="1.5"/>
            <rect x="2" y="10" width="12" height="4" stroke="currentColor" stroke-width="1.5"/>
            <line x1="2" y1="8" x2="14" y2="8" stroke="currentColor" stroke-width="1.5" stroke-dasharray="2 2"/>
          </svg>
        </button>
        <button class="cell-action" type="button" (click)="onSplitColsFromToolbar()" title="Split Columns">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="2" y="2" width="4" height="12" stroke="currentColor" stroke-width="1.5"/>
            <rect x="10" y="2" width="4" height="12" stroke="currentColor" stroke-width="1.5"/>
            <line x1="8" y1="2" x2="8" y2="14" stroke="currentColor" stroke-width="1.5" stroke-dasharray="2 2"/>
          </svg>
        </button>
      </div>
    }
  }
</div>

@if (showCellEditor()) {
  <app-cell-editor-dialog
    [initialContent]="getCellContentRaw(designerState.selectedTableCell()!.row, designerState.selectedTableCell()!.col)"
    (saved)="onCellEditorSaved($event)"
    (closed)="onCellEditorClosed()"
  ></app-cell-editor-dialog>
}
