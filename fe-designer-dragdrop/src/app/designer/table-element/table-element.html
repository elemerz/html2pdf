@let rowSizes = getRowSizes();
@let colSizes = getColSizes();

<div class="table-element-container">
  <table class="element-table" aria-label="Table element" [attr.data-repeat-over]="repeatTableBinding()?.binding" [attr.data-repeat-var]="repeatTableBinding()?.iteratorName">
    <tbody [attr.data-repeat-over]="repeatTbodyBinding()?.binding" [attr.data-repeat-var]="repeatTbodyBinding()?.iteratorName">
      @for (rowSize of rowSizes; track $index; let rowIndex = $index) {
        <tr [style.height.mm]="element.height * rowSize" [attr.data-repeat-over]="repeatRowBinding(rowIndex)?.binding" [attr.data-repeat-var]="repeatRowBinding(rowIndex)?.iteratorName">
          @for (colSize of colSizes; track $index; let colIndex = $index) {
            <td
              [style.width.mm]="element.width * colSize"
              [style.height.mm]="element.height * rowSize"
              [class.selected]="isCellSelected(rowIndex, colIndex)"
              [attr.data-row]="rowIndex"
              [attr.data-col]="colIndex"
              (click)="onCellClick($event,rowIndex,colIndex)" (dblclick)="onCellDoubleClick($event,rowIndex,colIndex)"
              [attr.data-has-subtable]="hasSubTable(rowIndex, colIndex) ? 'true' : null"
              [style.padding]="getCellPaddingString(rowIndex,colIndex)"
              [style.text-align]="getCellHAlign(rowIndex,colIndex)"
              [style.vertical-align]="getCellVAlign(rowIndex,colIndex)"
              [style.borderTop]="getCellBorderCss(rowIndex,colIndex,'top')"
              [style.borderRight]="getCellBorderCss(rowIndex,colIndex,'right')"
              [style.borderBottom]="getCellBorderCss(rowIndex,colIndex,'bottom')"
              [style.borderLeft]="getCellBorderCss(rowIndex,colIndex,'left')"
              [style.font-style]="getCellFontStyle(rowIndex,colIndex)"
              [style.font-weight]="getCellFontWeight(rowIndex,colIndex)"
              [style.font-size]="getCellFontSize(rowIndex,colIndex)"
              [style.line-height]="getCellLineHeight(rowIndex,colIndex)"
              [style.font-family]="getCellFontFamily(rowIndex,colIndex)"
              [style.text-decoration]="getCellTextDecoration(rowIndex,colIndex)"
            >
              @if (hasSubTable(rowIndex, colIndex)) {
                <!-- Render sub-table -->
                <div class="sub-table-container" 
                     [innerHTML]="getSubTableHtml(rowIndex, colIndex)"></div>
              } @else {
                <!-- Normal cell content -->
                <div class="cell-content"
                     [style.display]="'flex'"
                     [style.flexDirection]="'column'"
                     [style.justifyContent]="getCellVAlignFlex(rowIndex,colIndex)"
                     [style.textAlign]="getCellHAlign(rowIndex,colIndex)"
                     [style.overflow]="'auto'"
                     [innerHTML]="getCellContent(rowIndex, colIndex)"></div>
              }
            </td>
          }
        </tr>
      }
    </tbody>
  </table>

  @for (_ of rowSizes; track $index; let rowIndex = $index) {
    @if (rowIndex < rowSizes.length - 1) {
      <div
        class="table-resize-handle horizontal"
        [style.top.%]="getRowHandleOffset(rowSizes, rowIndex)"
        [class.resizing]="isResizing('row', rowIndex)"
        (mousedown)="startRowResize(rowIndex, $event)"
      >
        <span class="resize-handle resize-handle-top" aria-hidden="true"></span>
      </div>
    }
  }

  @for (_ of colSizes; track $index; let colIndex = $index) {
    @if (colIndex < colSizes.length - 1) {
      <div
        class="table-resize-handle vertical"
        [style.left.%]="getColHandleOffset(colSizes, colIndex)"
        [class.resizing]="isResizing('col', colIndex)"
        (mousedown)="startColResize(colIndex, $event)"
      >
        <span class="resize-handle resize-handle-left" aria-hidden="true"></span>
      </div>
    }
  }

  @let cellOffsets = getSelectedCellOffsets();
  @if (cellOffsets) {
    @let breadcrumb = getSelectedSubTableAncestors();
    @if (breadcrumb.length) {
      <div
        class="cell-selection-breadcrumb"
        [style.left.mm]="cellOffsets.left + cellOffsets.width / 2"
        [style.top.mm]="cellOffsets.top > 4 ? cellOffsets.top - 4 : 0"
        style="transform: translate(-50%, -100%);"
      >
        @for (crumb of breadcrumb; track crumb.level; let crumbIndex = $index) {
          <button
            type="button"
            class="breadcrumb-item"
            (click)="onBreadcrumbClick(crumb.path, $event)"
            [title]="'Select ancestor level ' + crumb.label"
          >{{ crumb.label }}</button>
          @if (crumbIndex < breadcrumb.length - 1) {
            <span class="breadcrumb-separator">&gt;</span>
          }
        }
      </div>
    }

    <!-- Actions trigger button (gear icon) -->
    <button
      class="cell-actions-trigger"
      [style.left.mm]="cellOffsets.left + cellOffsets.width - 5"
      [style.top.mm]="cellOffsets.top + 2"
      (click)="toggleActionsToolbar(); $event.stopPropagation()"
      title="Actions"
      type="button"
    >âš™</button>

    <!-- Actions toolbar (shown when toggled) -->
    @if (showActionsToolbar()) {
      <div
        class="cell-actions-toolbar"
        [style.left.mm]="cellOffsets.left + cellOffsets.width / 2"
        [style.top.mm]="cellOffsets.top"
        (click)="$event.stopPropagation()"
      >
        <button class="cell-action" type="button" (click)="onEditCellContent()" title="Edit Cell Content">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M11.5 1.5L14.5 4.5L5 14H2V11L11.5 1.5Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <button class="cell-action" type="button" (click)="onSplitCellIntoSubTable()" title="Split Cell into Sub-Table">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <!-- Outer cell border -->
            <rect x="1" y="1" width="14" height="14" stroke="currentColor" stroke-width="1.5" rx="1"/>
            <!-- Inner 2x2 grid -->
            <line x1="8" y1="4" x2="8" y2="12" stroke="currentColor" stroke-width="1.2"/>
            <line x1="4" y1="8" x2="12" y2="8" stroke="currentColor" stroke-width="1.2"/>
          </svg>
        </button>
        <button class="cell-action" type="button" (click)="onSplitRowsFromToolbar()" title="Split Rows">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="2" y="2" width="12" height="4" stroke="currentColor" stroke-width="1.5"/>
            <rect x="2" y="10" width="12" height="4" stroke="currentColor" stroke-width="1.5"/>
            <line x1="2" y1="8" x2="14" y2="8" stroke="currentColor" stroke-width="1.5" stroke-dasharray="2 2"/>
          </svg>
        </button>
        <button class="cell-action" type="button" (click)="onDeleteRowFromToolbar()" title="Delete Row">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <!-- Horizontal line (row indicator) -->
            <line x1="1" y1="8" x2="15" y2="8" stroke="currentColor" stroke-width="2.5"/>
            <!-- Red X -->
            <path d="M4 4L12 12M12 4L4 12" stroke="#dc2626" stroke-width="2.5" stroke-linecap="round"/>
          </svg>
        </button>
        <button class="cell-action" type="button" (click)="onSplitColsFromToolbar()" title="Split Columns">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="2" y="2" width="4" height="12" stroke="currentColor" stroke-width="1.5"/>
            <rect x="10" y="2" width="4" height="12" stroke="currentColor" stroke-width="1.5"/>
            <line x1="8" y1="2" x2="8" y2="14" stroke="currentColor" stroke-width="1.5" stroke-dasharray="2 2"/>
          </svg>
        </button>
        <button class="cell-action" type="button" (click)="onDeleteColFromToolbar()" title="Delete Column">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <!-- Vertical line (column indicator) -->
            <line x1="8" y1="1" x2="8" y2="15" stroke="currentColor" stroke-width="2.5"/>
            <!-- Red X -->
            <path d="M4 4L12 12M12 4L4 12" stroke="#dc2626" stroke-width="2.5" stroke-linecap="round"/>
          </svg>
        </button>
        <button class="cell-action" type="button" (click)="onDeleteSubTableFromToolbar()" [disabled]="!isDeleteSubTableEnabled()" title="Delete Sub-Table">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <!-- Outer cell border -->
            <rect x="2" y="2" width="16" height="16" stroke="currentColor" stroke-width="1.5" rx="1"/>
            <!-- Inner 2x2 grid -->
            <line x1="10" y1="5" x2="10" y2="15" stroke="currentColor" stroke-width="1.2"/>
            <line x1="5" y1="10" x2="15" y2="10" stroke="currentColor" stroke-width="1.2"/>
            <!-- Red delete cross overlay (top-right) -->
            <g transform="translate(11,1)">
              <circle cx="5" cy="5" r="4.3" fill="white" stroke="#dc2626" stroke-width="1"/>
              <path d="M3.2 3.2L6.8 6.8M6.8 3.2L3.2 6.8" stroke="#dc2626" stroke-width="2" stroke-linecap="round"/>
            </g>
          </svg>
        </button>
        <button class="cell-action" type="button" (click)="onSetRepeatBindingFromToolbar()" title="Repeat Over Collection">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M7 7h10a4 4 0 1 1 0 8h-2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <polyline points="9 11 5 7 9 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M17 17H7a4 4 0 1 1 0-8h2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <polyline points="15 13 19 17 15 21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    }
  }
</div>

@if (showCellEditor() && editorCellSelection()) {
  <app-cell-editor-dialog
    [initialContent]="getCellContentRaw(editorCellSelection()!.row, editorCellSelection()!.col)"
    (saved)="onCellEditorSaved($event)"
    (closed)="onCellEditorClosed()"
  ></app-cell-editor-dialog>
}
@if (showRepeatBindingDialog()) {
  <app-repeat-binding-dialog
    [initialBinding]="getRepeatBindingForSelection()?.binding"
    [initialIterator]="getRepeatBindingForSelection()?.iteratorName"
    [initialRepeatedElement]="getRepeatBindingForSelection()?.repeatedElement"
    (saved)="onRepeatBindingSaved($event)"
    (closed)="onRepeatBindingClosed()"
  ></app-repeat-binding-dialog>
}
