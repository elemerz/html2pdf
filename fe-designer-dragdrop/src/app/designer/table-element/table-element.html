@let rowSizes = getRowSizes();
@let colSizes = getColSizes();

<div class="table-element-container">
  <table class="element-table" aria-label="Table element">
    <tbody>
      @for (rowSize of rowSizes; track $index; let rowIndex = $index) {
        <tr [style.height.mm]="element.height * rowSize">
          @for (colSize of colSizes; track $index; let colIndex = $index) {
            <td
              [style.width.mm]="element.width * colSize"
              [style.height.mm]="element.height * rowSize"
              (click)="onCellClick($event, rowIndex, colIndex)"
              (contextmenu)="onCellContextMenu($event, rowIndex, colIndex)"
              [class.selected]="isCellSelected(rowIndex, colIndex)"
              [style.padding-top.mm]="getCellPadding(rowIndex,colIndex).top"
              [style.padding-right.mm]="getCellPadding(rowIndex,colIndex).right"
              [style.padding-bottom.mm]="getCellPadding(rowIndex,colIndex).bottom"
              [style.padding-left.mm]="getCellPadding(rowIndex,colIndex).left"
              [style.text-align]="getCellHAlign(rowIndex,colIndex)"
              [style.vertical-align]="getCellVAlign(rowIndex,colIndex)"
              [style.border]="getCellBorder(rowIndex,colIndex)"
              [style.font-style]="getCellFontStyle(rowIndex,colIndex)"
              [style.font-weight]="getCellFontWeight(rowIndex,colIndex)"
              [style.font-size]="getCellFontSize(rowIndex,colIndex)"
              [style.line-height]="getCellLineHeight(rowIndex,colIndex)"
              [style.font-family]="getCellFontFamily(rowIndex,colIndex)"
              [style.text-decoration]="getCellTextDecoration(rowIndex,colIndex)"
            >
              <div class="cell-content"
                   [style.display]="'flex'"
                   [style.flexDirection]="'column'"
                   [style.justifyContent]="getCellVAlignFlex(rowIndex,colIndex)"
                   [style.textAlign]="getCellHAlign(rowIndex,colIndex)"
                   [style.overflow]="'auto'"
                   [innerHTML]="getCellContent(rowIndex, colIndex)"></div>
            </td>
          }
        </tr>
      }
    </tbody>
  </table>

  @for (_ of rowSizes; track $index; let rowIndex = $index) {
    @if (rowIndex < rowSizes.length - 1) {
      <div
        class="table-resize-handle horizontal"
        [style.top.%]="getRowHandleOffset(rowSizes, rowIndex)"
        [class.resizing]="isResizing('row', rowIndex)"
        (mousedown)="startRowResize(rowIndex, $event)"
      ></div>
    }
  }

  @for (_ of colSizes; track $index; let colIndex = $index) {
    @if (colIndex < colSizes.length - 1) {
      <div
        class="table-resize-handle vertical"
        [style.left.%]="getColHandleOffset(colSizes, colIndex)"
        [class.resizing]="isResizing('col', colIndex)"
        (mousedown)="startColResize(colIndex, $event)"
      ></div>
    }
  }

  @if (showContextMenu()) {
    <div
      class="table-context-menu"
      [style.left.px]="contextMenuPosition().x"
      [style.top.px]="contextMenuPosition().y"
      (click)="$event.stopPropagation()"
    >
      <button class="context-item" type="button" (click)="onSplitHorizontally()">
        Split Horizontally by "n" (default 2)
      </button>
      <button class="context-item" type="button" (click)="onSplitVertically()">
        Split Vertically by "n" (default 2)
      </button>
    </div>
  }

  @let cellOffsets = getSelectedCellOffsets();
  @if (cellOffsets) {
    <div
      class="cell-actions-toolbar"
      [style.left.mm]="cellOffsets.left + cellOffsets.width / 2"
      [style.top.mm]="cellOffsets.top"
      (click)="$event.stopPropagation()"
    >
      <button class="cell-action" type="button" (click)="onEditCellContent()" title="Edit Cell Content">‚úè</button>
    </div>
  }
</div>

@if (showContextMenu()) {
  <div class="table-context-menu-overlay" (click)="closeContextMenu()"></div>
}

@if (showCellEditor()) {
  <app-cell-editor-dialog
    [initialContent]="getCellContentRaw(designerState.selectedTableCell()!.row, designerState.selectedTableCell()!.col)"
    (saved)="onCellEditorSaved($event)"
    (closed)="onCellEditorClosed()"
  ></app-cell-editor-dialog>
}
