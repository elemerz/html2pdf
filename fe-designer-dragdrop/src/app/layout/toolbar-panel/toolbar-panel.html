<div class="toolbar-panel" data-testid="toolbar-panel">
  @for (category of categories; track category.id) {
    <div class="accordion-item">
      <button
        class="accordion-header"
        (click)="toggleCategory(category.id)"
        [attr.data-testid]="'category-' + category.id">
        <span>{{ category.label }}</span>
        <span class="chevron" [class.expanded]="expandedCategory() === category.id">‚Ä∫</span>
      </button>

      @if (expandedCategory() === category.id) {
        <div class="accordion-content">
          @if (!category.passive) {
            <div class="elements-grid">
              @for (element of getElementsForCategory(category.id); track element.type) {
                <div
                  class="element-item"
                  draggable="true"
                  (dragstart)="onDragStart($event, element)"
                  (dragend)="onDragEnd()"
                  [attr.data-testid]="'element-' + element.type">
                  <div class="element-preview">
                    @switch (element.type) {
                      @case ('div') { <div class="container-preview">Div</div> }
                      @case ('table') { <div class="container-preview">Define Layout</div> }
                    }
                  </div>
                </div>
              }
            </div>
          } @else if (category.id === 'report-data-model') {
            <button class="json-import-btn" (click)="onImportJson()">
              üìÅ Import JSON
            </button>
            <div class="json-viewer">
              @for (node of jsonTree(); track node.path) {
                <div class="json-node" [style.padding-left.px]="0">
                  @if (node.type === 'object' || node.type === 'array') {
                    <div class="json-line json-expandable" (click)="toggleJsonNode(node)">
                      <span class="json-chevron" [class.expanded]="node.expanded">‚ñ∂</span>
                      <span class="json-key">{{ node.key }}:</span>
                      <span class="json-value">{{ getValuePreview(node) }}</span>
                    </div>
                    @if (node.expanded && node.children) {
                      <div class="json-children">
                        @for (child of node.children; track child.path) {
                          <div class="json-node" [style.padding-left.px]="12">
                            @if (child.type === 'object' || child.type === 'array') {
                              <div class="json-line json-expandable" (click)="toggleJsonNode(child)">
                                <span class="json-chevron" [class.expanded]="child.expanded">‚ñ∂</span>
                                <span class="json-key">{{ child.key }}:</span>
                                <span class="json-value">{{ getValuePreview(child) }}</span>
                              </div>
                              @if (child.expanded && child.children) {
                                <div class="json-children">
                                  @for (grandchild of child.children; track grandchild.path) {
                                    <div class="json-node" [style.padding-left.px]="24">
                                      @if (grandchild.type === 'object' || grandchild.type === 'array') {
                                        <div class="json-line json-expandable" (click)="toggleJsonNode(grandchild)">
                                          <span class="json-chevron" [class.expanded]="grandchild.expanded">‚ñ∂</span>
                                          <span class="json-key">{{ grandchild.key }}:</span>
                                          <span class="json-value">{{ getValuePreview(grandchild) }}</span>
                                        </div>
                                        @if (grandchild.expanded && grandchild.children) {
                                          <div class="json-children">
                                            @for (leaf of grandchild.children; track leaf.path) {
                                              <div class="json-node" [style.padding-left.px]="36">
                                                <div class="json-line">
                                                  <span class="json-key">{{ leaf.key }}:</span>
                                                  <span class="json-value" [ngClass]="getValueClass(leaf.value)">{{ getValuePreview(leaf) }}</span>
                                                </div>
                                              </div>
                                            }
                                          </div>
                                        }
                                      } @else {
                                        <div class="json-line">
                                          <span class="json-key">{{ grandchild.key }}:</span>
                                          <span class="json-value" [ngClass]="getValueClass(grandchild.value)">{{ getValuePreview(grandchild) }}</span>
                                        </div>
                                      }
                                    </div>
                                  }
                                </div>
                              }
                            } @else {
                              <div class="json-line">
                                <span class="json-key">{{ child.key }}:</span>
                                <span class="json-value" [ngClass]="getValueClass(child.value)">{{ getValuePreview(child) }}</span>
                              </div>
                            }
                          </div>
                        }
                      </div>
                    }
                  } @else {
                    <div class="json-line">
                      <span class="json-key">{{ node.key }}:</span>
                      <span class="json-value" [ngClass]="getValueClass(node.value)">{{ getValuePreview(node) }}</span>
                    </div>
                  }
                </div>
              }
            </div>
          } @else {
            <div class="element-preview passive-note">To be implemented</div>
          }
        </div>
      }
    </div>
  }
</div>
